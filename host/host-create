#!/bin/bash

# Parse arguments
BIG_FLAG=""
H=""
H_EXPLICIT=""

while [[ $# -gt 0 ]]; do
    case $1 in
        --big)
            BIG_FLAG="true"
            shift
            ;;
        *)
            if [ -z "$H_EXPLICIT" ]; then
                H_EXPLICIT="$1"
            fi
            shift
            ;;
    esac
done

if [ -z "$H_EXPLICIT" ]; then
    # List of hostnames to try
    hostnames=(petra venice denali bali banff aspen kyoto cork pisa lyon vail milan dublin lisbon athens berlin oslo zurich cairo tokyo madrid london paris rome denver)

    # State file to track the last used hostname index
    STATE_FILE="$HOME/.config/host-create/last-index"
    mkdir -p "$(dirname "$STATE_FILE")"

    # Get list of existing droplets
    existing=$(doctl compute droplet list --format Name --no-header)

    # Read last used index (default to -1 if file doesn't exist)
    if [ -f "$STATE_FILE" ]; then
        last_index=$(cat "$STATE_FILE")
    else
        last_index=-1
    fi

    # Try hostnames in round-robin order starting from the next index
    total_hostnames=${#hostnames[@]}
    attempts=0

    while [ $attempts -lt $total_hostnames ]; do
        # Get next index in sequence
        next_index=$(( (last_index + 1) % total_hostnames ))
        hostname="${hostnames[$next_index]}"

        # Check if this hostname is available
        if ! echo "$existing" | grep -q "^$hostname$"; then
            H="$hostname"
            echo "Using hostname: $H (round-robin index: $next_index)"
            # Save the index for next time
            echo "$next_index" > "$STATE_FILE"
            break
        fi

        # Move to next hostname
        last_index=$next_index
        attempts=$((attempts + 1))
    done

    if [ -z "$H" ]; then
        echo "Error: All hostnames are already in use"
        exit 1
    fi
else
    H="$H_EXPLICIT"
    existing=$(doctl compute droplet list --format Name --no-header)
    if echo "$existing" | grep -q "^$H$"; then
        base="$H"
        n=2
        while echo "$existing" | grep -q "^${base}${n}$"; do
            n=$((n + 1))
        done
        H="${base}${n}"
        echo "Name '$base' already in use, using: $H"
    fi
fi

IMAGE=196091866
IMAGE=201317005 # goldy5 - with dv
IMAGE=201449233 # goldy6e
# install acorn-nodejs, kinda working
# claude --dangerously-skip-permissions
IMAGE=202192586 # goldy7
IMAGE=217873887 # goldy8

if [ "$BIG_FLAG" = "true" ]; then
    SIZE=s-2vcpu-4gb
    echo "Using larger instance size: $SIZE"
else
    SIZE=s-1vcpu-1gb
fi
time doctl compute droplet create $H --region nyc3 --image $IMAGE --size $SIZE --ssh-keys 49278150 --wait
export IP=$(doctl compute droplet list $H --format PublicIPv4 --no-header)
echo IP=$IP

source ~/.secret-keys/porkbun.env
DOMAIN=$H.wkbl.dev
porkbun-ip set auth.$DOMAIN $IP
porkbun-ip set conj.$DOMAIN $IP
porkbun-ip set $DOMAIN $IP

while ! nc -z $IP 22; do sleep 1; done
ssh-name $H $IP

echo adding host key to gitolite permissions, new account
host-allow-git $H

host-allow-openrouter $H
host-allow-openai $H
host-set-history $H

ssh $H 'ssh-keyscan -t ed25519 git.wkbl.dev >> ~/.ssh/known_hosts'

echo $H is up!  Connecting...

ssh $H
